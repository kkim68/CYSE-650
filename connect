#!/bin/bash

GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${BLUE}=== SSH Connection Helper ===${NC}\n"

read -p "Input IP Address of the host: " ip_address

if [ -z "$ip_address" ]; then
    echo -e "${YELLOW}IP Address reqruied.${NC}"
    exit 1
fi

echo -e "\n${GREEN}Usable SSH Key list:${NC}"

ssh_dir="$HOME/.ssh"
if [ ! -d "$ssh_dir" ]; then
    echo -e "${YELLOW}~/.ssh directory does not exist.${NC}"
    exit 1
fi

keys=()
index=1

for file in "$ssh_dir"/*; do
    if [ -f "$file" ] && [[ ! "$file" == *.pub ]] && [[ ! "$(basename "$file")" == .* ]] && [[ ! "$(basename "$file")" == known_hosts* ]] && [[ ! "$(basename "$file")" == config ]]; then
        keys+=("$file")
        echo "$index) $(basename "$file")"
        ((index++))
    fi
done

if [ ${#keys[@]} -eq 0 ]; then
    echo -e "${YELLOW}No SSH Key was found.${NC}"
    exit 1
fi

# 키 선택
read -p $'\nSelect SSH Key number to use: ' key_number

if ! [[ "$key_number" =~ ^[0-9]+$ ]] || [ "$key_number" -lt 1 ] || [ "$key_number" -gt ${#keys[@]} ]; then
    echo -e "${YELLOW}Wrong number.${NC}"
    exit 1
fi

selected_key="${keys[$((key_number-1))]}"
echo -e "${GREEN}Selected Key: $(basename "$selected_key")${NC}"

# 3) Username 입력받기
read -p $'\nUsername for the host: ' username

if [ -z "$username" ]; then
    echo -e "${YELLOW}Requires Username.${NC}"
    exit 1
fi

# 4) SSH 연결 실행
echo -e "\n${BLUE}Establishing SSH ...${NC}"
echo "ssh -i $selected_key $username@$ip_address"
echo ""

ssh -i "$selected_key" "$username@$ip_address"